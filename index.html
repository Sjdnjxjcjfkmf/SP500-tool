<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>索罗斯指数分析工具（V13 专业版）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- 配置Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#FF7D00',
                        danger: '#F53F3F',
                        neutral: '#86909C',
                        light: '#F2F3F5',
                        dark: '#1D2129'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .transition-custom {
                transition: all 0.3s ease;
            }
            .pulse-effect {
                animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
                0% {
                    box-shadow: 0 0 0 0 rgba(22, 93, 255, 0.4);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(22, 93, 255, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(22, 93, 255, 0);
                }
            }
            .shake {
                animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            }
            @keyframes shake {
                10%, 90% { transform: translate3d(-1px, 0, 0); }
                20%, 80% { transform: translate3d(2px, 0, 0); }
                30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
                40%, 60% { transform: translate3d(4px, 0, 0); }
            }
            /* 管理员模式样式 */
            .admin-panel {
                background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
                color: #e2e8f0;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark overflow-hidden"> <!-- 初始禁止滚动 -->

    <!-- ================= 激活码遮罩层 ================= -->
    <div id="activationOverlay" class="fixed inset-0 z-[100] bg-gray-900 flex items-center justify-center transition-all duration-700">
        <!-- 背景装饰 -->
        <div class="absolute inset-0 overflow-hidden opacity-20 pointer-events-none">
            <div class="absolute top-0 left-0 w-96 h-96 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob"></div>
            <div class="absolute top-0 right-0 w-96 h-96 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000"></div>
            <div class="absolute -bottom-32 left-20 w-96 h-96 bg-pink-500 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-4000"></div>
        </div>

        <!-- 普通用户激活界面 -->
        <div id="userActivationPanel" class="bg-white/95 backdrop-blur-sm p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 text-center relative z-10 border border-white/20">
            <div class="mb-8">
                <div class="w-20 h-20 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg transform rotate-3 hover:rotate-6 transition-transform">
                    <i class="fa fa-shield text-4xl text-white"></i>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-3">产品激活</h2>
                <p class="text-gray-500 text-sm">系统将绑定当前设备<br>更换浏览器或设备需重新激活</p>
            </div>
            
            <div class="space-y-5">
                <div class="relative">
                    <i class="fa fa-key absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="activationCodeInput" placeholder="请输入激活码 (格式: XXXX-XXXX-XXXX)" 
                        class="w-full pl-12 pr-4 py-4 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all text-lg tracking-widest uppercase font-mono text-gray-800"
                        autocomplete="off">
                </div>
                
                <div id="deviceInfo" class="text-xs text-gray-400 bg-gray-100 p-2 rounded-lg flex items-center justify-center">
                    <i class="fa fa-desktop mr-2"></i>
                    <span id="fingerprintStatus">正在计算设备指纹...</span>
                </div>

                <p id="activationError" class="text-red-500 text-sm font-medium hidden flex items-center justify-center animate-bounce">
                    <i class="fa fa-times-circle mr-1"></i> 激活码无效或设备不匹配
                </p>
                
                <button id="activateBtn" class="w-full py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all font-bold text-lg shadow-lg shadow-blue-500/30 transform hover:-translate-y-0.5" disabled>
                    正在初始化安全组件...
                </button>
                
                <!-- 管理员提示已隐藏，但功能保留 -->
                <div class="pt-4 border-t border-gray-100 hidden">
                    <p class="text-xs text-gray-400">
                        <!-- 管理员指令隐藏 -->
                    </p>
                </div>
            </div>
        </div>

        <!-- 管理员后台界面 (默认隐藏) -->
        <div id="adminPanel" class="hidden admin-panel p-8 rounded-2xl shadow-2xl max-w-lg w-full mx-4 text-center relative z-20 border border-gray-700">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
                <h2 class="text-2xl font-bold text-white flex items-center">
                    <i class="fa fa-cogs mr-2 text-accent"></i> 激活码生成后台
                </h2>
                <button id="closeAdminBtn" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>

            <div class="space-y-6">
                <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700 text-left">
                    <p class="text-sm text-gray-400 mb-2">当前密钥 (Secret Key):</p>
                    <code class="text-xs bg-black/30 p-2 rounded block break-all text-green-400 font-mono" id="currentSecretDisplay"></code>
                    <p class="text-xs text-gray-500 mt-2">* 所有的验证都依赖此密钥，请勿泄露</p>
                </div>

                <div class="flex space-x-4">
                    <input type="number" id="genCount" value="5" min="1" max="50" class="w-24 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-accent text-center" placeholder="数量">
                    <button id="generateBtn" class="flex-1 py-2 bg-accent text-white rounded-lg hover:bg-accent/90 transition-colors font-bold shadow-lg shadow-accent/20">
                        <i class="fa fa-magic mr-2"></i> 生成激活码
                    </button>
                </div>

                <div class="relative">
                    <textarea id="generatedCodesArea" rows="6" readonly class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-green-400 font-mono text-sm focus:outline-none resize-none" placeholder="生成的激活码将显示在这里..."></textarea>
                    <button id="copyCodesBtn" class="absolute top-2 right-2 px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs text-white transition-colors">
                        复制
                    </button>
                </div>
                
                <p class="text-xs text-gray-500">
                    * 复制这些激活码发送给用户，他们即可在首页解锁。
                </p>
            </div>
        </div>
    </div>
    <!-- ================= 激活码遮罩层结束 ================= -->

    <!-- 导航栏 -->
    <nav class="bg-white shadow-sm sticky top-0 z-40 transition-custom">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-line-chart text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">索罗斯指数分析工具（V13）</h1>
            </div>
            <div class="hidden md:flex items-center space-x-6">
                <a href="#" class="text-neutral hover:text-primary transition-custom">首页</a>
                <a href="#about" class="text-neutral hover:text-primary transition-custom">使用说明</a>
                <a href="#data" class="text-neutral hover:text-primary transition-custom">数据</a>
                <button id="themeToggle" class="p-2 rounded-full hover:bg-light transition-custom">
                    <i class="fa fa-moon-o text-neutral"></i>
                </button>
            </div>
            <button class="md:hidden text-neutral text-xl">
                <i class="fa fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- 主要内容 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 介绍部分 -->
        <section class="mb-12 text-center">
            <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-4">索罗斯指数分析与可视化</h2>
            <p class="text-neutral max-w-3xl mx-auto">
                V13版本 | 采用AI算法模型，计算索罗斯指数，包含波普尔指标X及其状态显示。
            </p>
        </section>

        <!-- 当前数据信息 -->
        <section class="bg-white rounded-xl p-6 mb-8 card-shadow">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h3 class="text-lg font-semibold mb-2 flex items-center">
                        <i class="fa fa-database text-primary mr-2"></i>数据信息
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-2 text-sm">
                        <div>
                            <span class="text-neutral">当前文件:</span>
                            <span id="currentFileName" class="font-medium ml-1">未加载数据</span>
                        </div>
                        <div>
                            <span class="text-neutral">数据点数量:</span>
                            <span id="dataPointCount" class="font-medium ml-1">0</span>
                        </div>
                        <div>
                            <span class="text-neutral">检测到的间隔:</span>
                            <span id="detectedInterval" class="font-medium ml-1">--</span>
                        </div>
                        <div>
                            <span class="text-neutral">日期范围:</span>
                            <span id="dateRange" class="font-medium ml-1">-- 至 --</span>
                        </div>
                        <div>
                            <span class="text-neutral">最新指数值:</span>
                            <span id="latestIndexValue" class="font-medium ml-1">--</span>
                        </div>
                    </div>
                </div>
                
                <div class="w-full md:w-auto">
                    <h3 class="text-lg font-semibold mb-2 flex items-center">
                        <i class="fa fa-signal text-primary mr-2"></i>当前状态
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div id="arh999Status" class="px-4 py-3 bg-gray-100 rounded-lg text-center">
                            <span class="inline-block px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-800">
                                索罗斯指数状态：等待数据加载
                            </span>
                        </div>
                        <div id="popperStatus" class="px-4 py-3 bg-gray-100 rounded-lg text-center">
                            <span class="inline-block px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-800">
                                波普尔状态：等待数据加载
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 波普尔指标和增长率统计 -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white rounded-xl p-5 card-shadow border-l-4 border-purple-500">
                <h4 class="text-sm font-medium text-neutral mb-1">波普尔指标X</h4>
                <div class="flex items-end justify-between">
                    <div>
                        <p id="popperIndexX" class="text-2xl font-bold">--</p>
                        <p class="text-xs text-purple-500 mt-1">索罗斯指数 / 增长速率</p>
                    </div>
                    <i class="fa fa-balance-scale text-purple-500 text-2xl"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-5 card-shadow border-l-4 border-blue-500">
                <h4 class="text-sm font-medium text-neutral mb-1">平均增长速率</h4>
                <div class="flex items-end justify-between">
                    <div>
                        <p id="averageGrowthRate" class="text-2xl font-bold">--</p>
                        <p class="text-xs text-blue-500 mt-1">所有数据点的平均增长速度</p>
                    </div>
                    <i class="fa fa-area-chart text-blue-500 text-2xl"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-5 card-shadow border-l-4 border-green-500">
                <h4 class="text-sm font-medium text-neutral mb-1">增长率单位</h4>
                <div class="flex items-end justify-between">
                    <div>
                        <p id="growthRateUnit" class="text-2xl font-bold">--</p>
                        <p class="text-xs text-green-500 mt-1">根据数据间隔自动适配</p>
                    </div>
                    <i class="fa fa-clock-o text-green-500 text-2xl"></i>
                </div>
            </div>
        </section>

        <!-- 控制面板 -->
        <section class="bg-white rounded-xl p-6 mb-8 card-shadow">
            <div class="flex flex-col md:flex-row justify-between gap-6">
                <div class="flex-1">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-cogs text-primary mr-2"></i>数据控制
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-neutral mb-1">数据来源</label>
                            <div class="flex gap-3">
                                <button id="useSampleMonthlyData" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-custom flex-1">
                                    月度示例数据
                                </button>
                                <button id="useSampleYearlyData" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-custom flex-1">
                                    年度示例数据
                                </button>
                            </div>
                            <div class="mt-3">
                                <label for="uploadData" class="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary/5 transition-custom w-full inline-block text-center cursor-pointer">
                                    <i class="fa fa-upload mr-1"></i> 上传数据文件 (CSV, Excel)
                                </label>
                                <input id="uploadData" type="file" accept=".csv,.txt,.xlsx,.xls" class="hidden">
                                <p class="text-xs text-neutral mt-1">支持CSV、TXT和Excel格式（.xlsx, .xls）</p>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-neutral mb-1">时间范围</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-neutral">开始日期</label>
                                    <input id="startDate" type="month" class="w-full p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                                </div>
                                <div>
                                    <label class="text-xs text-neutral">结束日期</label>
                                    <input id="endDate" type="month" class="w-full p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex-1">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-sliders text-primary mr-2"></i>图表设置
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-neutral mb-1">显示指标</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center p-2 border border-gray-200 rounded-lg hover:bg-light transition-custom cursor-pointer">
                                    <input type="checkbox" id="showPrice" checked class="mr-2">
                                    <span>历史价格</span>
                                </label>
                                <label class="flex items-center p-2 border border-gray-200 rounded-lg hover:bg-light transition-custom cursor-pointer">
                                    <input type="checkbox" id="showIndex" checked class="mr-2">
                                    <span>索罗斯指数</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-neutral mb-1">参考线位置设置 (%)</label>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="text-xs text-neutral">黄金买入线</label>
                                    <input id="goldenBuyPercent" type="number" min="1" max="20" value="8" 
                                        class="w-full p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                                </div>
                                <div>
                                    <label class="text-xs text-neutral">定投线</label>
                                    <input id="regularInvestPercent" type="number" min="5" max="40" value="20"
                                        class="w-full p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                                </div>
                                <div>
                                    <label class="text-xs text-neutral">泡沫线</label>
                                    <input id="bubblePercent" type="number" min="1" max="99" value="94"
                                        class="w-full p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                                    <p class="text-[10px] text-neutral mt-1">距离最低点的百分比</p>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-blue-500 flex items-center">
                                <i class="fa fa-info-circle mr-1"></i>
                                <span>修改后点击"更新图表"生效</span>
                            </div>
                        </div>
                        
                        <button id="updateChart" class="w-full py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-custom flex items-center justify-center">
                            <i class="fa fa-refresh mr-2"></i>更新图表
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 参考线统计信息 -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white rounded-xl p-5 card-shadow border-l-4 border-green-500">
                <h4 class="text-sm font-medium text-neutral mb-1">黄金买入线</h4>
                <div class="flex items-end justify-between">
                    <div>
                        <p id="goldenBuyValue" class="text-2xl font-bold">--</p>
                        <p class="text-xs text-green-500 mt-1">位于指数区间的<span id="goldenBuyPercentDisplay">8%</span>处</p>
                    </div>
                    <i class="fa fa-arrow-down text-green-500 text-2xl"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-5 card-shadow border-l-4 border-blue-500">
                <h4 class="text-sm font-medium text-neutral mb-1">定投线</h4>
                <div class="flex items-end justify-between">
                    <div>
                        <p id="regularInvestValue" class="text-2xl font-bold">--</p>
                        <p class="text-xs text-blue-500 mt-1">位于指数区间的<span id="regularInvestPercentDisplay">20%</span>处</p>
                    </div>
                    <i class="fa fa-arrow-right text-blue-500 text-2xl"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-5 card-shadow border-l-4 border-red-500">
                <h4 class="text-sm font-medium text-neutral mb-1">泡沫线</h4>
                <div class="flex items-end justify-between">
                    <div>
                        <p id="bubbleValue" class="text-2xl font-bold">--</p>
                        <p class="text-xs text-red-500 mt-1">位于指数区间的<span id="bubblePercentDisplay">94%</span>处</p>
                    </div>
                    <i class="fa fa-arrow-up text-red-500 text-2xl"></i>
                </div>
            </div>
        </section>

        <!-- 图表展示区 -->
        <section class="bg-white rounded-xl p-6 mb-8 card-shadow">
            <h3 class="text-lg font-semibold mb-6 flex items-center">
                <i class="fa fa-area-chart text-primary mr-2"></i>价格与索罗斯指数走势
            </h3>
            <div class="h-[500px] relative">
                <canvas id="mainChart"></canvas>
                <div id="chartLoader" class="absolute inset-0 flex items-center justify-center bg-white/80 z-10 hidden">
                    <div class="flex flex-col items-center">
                        <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                        <p class="mt-4 text-neutral">正在加载数据...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 数据表格 -->
        <section id="data" class="bg-white rounded-xl p-6 mb-8 card-shadow">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold flex items-center">
                    <i class="fa fa-table text-primary mr-2"></i>历史数据
                </h3>
                <button id="exportData" class="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary/5 transition-custom flex items-center">
                    <i class="fa fa-download mr-2"></i>导出数据
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-neutral uppercase tracking-wider">日期</th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-neutral uppercase tracking-wider">价格</th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-neutral uppercase tracking-wider">索罗斯指数</th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-neutral uppercase tracking-wider">波普尔指标X</th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-neutral uppercase tracking-wider">索罗斯指数状态</th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-neutral uppercase tracking-wider">波普尔状态</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- 数据将通过JavaScript动态填充 -->
                        <tr>
                            <td colspan="9" class="px-4 py-8 text-center text-neutral">请加载数据以显示表格内容</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="flex justify-between items-center mt-4 text-sm text-neutral">
                <div>显示 <span id="showingCount">0</span> 条记录</div>
                <div class="flex gap-2">
                    <button id="prevPage" class="px-3 py-1 border rounded hover:bg-light disabled:opacity-50 disabled:cursor-not-allowed" disabled>上一页</button>
                    <span id="pageInfo">第 0 页 / 共 0 页</span>
                    <button id="nextPage" class="px-3 py-1 border rounded hover:bg-light disabled:opacity-50 disabled:cursor-not-allowed" disabled>下一页</button>
                </div>
            </div>
        </section>

        <!-- 关于索罗斯指数 / 使用说明 -->
        <section id="about" class="bg-white rounded-xl p-6 mb-8 card-shadow">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-info-circle text-primary mr-2"></i>使用说明与数据格式
            </h3>
            <div class="space-y-4 text-neutral">
                <p>本工具支持导入自定义股票或资产的历史价格数据进行分析。为了确保分析的准确性，请准备 Excel 或 CSV 文件。</p>
                
                <p class="font-medium text-dark">推荐数据格式示例（支持月度或日度数据）：</p>
                
                <div class="bg-light p-4 rounded-lg font-mono text-sm overflow-x-auto">
                    <p class="mb-2 text-gray-500">// Excel 或 CSV 内容示例（两列：日期，价格）</p>
                    <table class="w-full max-w-xs">
                        <tr class="border-b border-gray-300">
                            <td class="py-1">2020-01</td>
                            <td class="py-1">9339</td>
                        </tr>
                        <tr class="border-b border-gray-300">
                            <td class="py-1">2020-02</td>
                            <td class="py-1">8650</td>
                        </tr>
                        <tr class="border-b border-gray-300">
                            <td class="py-1">2020-03</td>
                            <td class="py-1">6454</td>
                        </tr>
                        <tr class="border-b border-gray-300">
                            <td class="py-1">2020-04</td>
                            <td class="py-1">8776</td>
                        </tr>
                        <tr>
                            <td class="py-1">2020-05</td>
                            <td class="py-1">9480</td>
                        </tr>
                    </table>
                </div>
                
                <p>参考线计算说明：</p>
                <ul class="list-disc pl-6 space-y-2">
                    <li>黄金买入线、定投线及泡沫线均基于历史数据区间自动计算。</li>
                    <li>波普尔指标状态判断规则：根据数据间隔自动适配（月度或年度）进行“抄底”或“正常”的判断。</li>
                </ul>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-8">
        <div class="container mx-auto px-4 text-center text-neutral text-sm">
            <p>© 2023 索罗斯指数分析工具 | V13版本 | 专业版 | 仅供参考，不构成投资建议</p>
            <div class="mt-4 flex justify-center space-x-4">
                <a href="#" class="hover:text-primary transition-custom"><i class="fa fa-github text-xl"></i></a>
                <a href="#" class="hover:text-primary transition-custom"><i class="fa fa-twitter text-xl"></i></a>
                <a href="#" class="hover:text-primary transition-custom"><i class="fa fa-envelope text-xl"></i></a>
            </div>
        </div>
    </footer>

    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50">
        <i id="notificationIcon" class="mr-2"></i>
        <span id="notificationText"></span>
    </div>

    <script>
        // =======================================================
        // 核心安全配置 (商业版功能 - 设备绑定升级)
        // =======================================================
        
        const LICENSE_CONFIG = {
            SECRET_KEY: "MY_SUPER_SECRET_KEY_2025_CHANGE_ME",
            PREFIX_LEN: 8,
            CHECKSUM_LEN: 4,
            CHARSET: "ABCDEFGHJKLMNPQRSTUVWXYZ23456789",
            STORAGE_KEY: 'soros_license_v13_bound', // 存储键名
            DEVICE_SALT: 'SOROS_DEVICE_BINDING_SALT_V1', // 内部混淆盐值
        };

        // 简易哈希算法 (DJB2)
        function simpleHash(str) {
            let hash = 5381;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) + hash) + str.charCodeAt(i);
            }
            return Math.abs(hash).toString(16);
        }

        // =======================================================
        // 设备指纹生成器 (Fingerprint Generator)
        // =======================================================
        const FingerprintManager = {
            // 获取 Canvas 指纹 (浏览器唯一性极高)
            getCanvasFingerprint: function() {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 200;
                    canvas.height = 50;
                    
                    // 绘制包含特殊字符的文本
                    ctx.textBaseline = "top";
                    ctx.font = "14px 'Arial'";
                    ctx.textBaseline = "alphabetic";
                    ctx.fillStyle = "#f60";
                    ctx.fillRect(125, 1, 62, 20);
                    ctx.fillStyle = "#069";
                    ctx.fillText("Soros_Index_v13", 2, 15);
                    ctx.fillStyle = "rgba(102, 204, 0, 0.7)";
                    ctx.fillText("Fingerprint", 4, 17);
                    
                    return canvas.toDataURL();
                } catch (e) {
                    return "canvas_error";
                }
            },

            // 获取综合设备指纹
            getDeviceFingerprint: async function() {
                const components = [
                    navigator.userAgent,                // 浏览器/系统信息
                    screen.colorDepth,                  // 屏幕色彩
                    screen.width + 'x' + screen.height, // 分辨率
                    new Date().getTimezoneOffset(),     // 时区
                    navigator.language,                 // 语言
                    navigator.hardwareConcurrency || 'unknown', // CPU核心数
                    this.getCanvasFingerprint()         // Canvas渲染特征
                ];
                
                // 将所有特征拼接并哈希
                return simpleHash(components.join('###'));
            }
        };

        // 授权验证核心类 (升级版)
        const LicenseManager = {
            generateRandomString: function(length) {
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += LICENSE_CONFIG.CHARSET.charAt(Math.floor(Math.random() * LICENSE_CONFIG.CHARSET.length));
                }
                return result;
            },

            calculateChecksum: function(prefix) {
                const mix = prefix + LICENSE_CONFIG.SECRET_KEY;
                let hashVal = parseInt(simpleHash(mix), 16); // 复用simpleHash
                
                let checksum = '';
                for (let i = 0; i < LICENSE_CONFIG.CHECKSUM_LEN; i++) {
                    const charIndex = hashVal % LICENSE_CONFIG.CHARSET.length;
                    checksum += LICENSE_CONFIG.CHARSET.charAt(charIndex);
                    hashVal = Math.floor(hashVal / LICENSE_CONFIG.CHARSET.length);
                }
                return checksum;
            },

            generateCode: function() {
                const prefix = this.generateRandomString(LICENSE_CONFIG.PREFIX_LEN);
                const checksum = this.calculateChecksum(prefix);
                const rawCode = prefix + checksum;
                return rawCode.match(/.{1,4}/g).join('-');
            },

            // 基础格式校验
            isValidFormat: function(inputCode) {
                const cleanCode = inputCode.replace(/[-\s]/g, '').toUpperCase();
                if (cleanCode.length !== (LICENSE_CONFIG.PREFIX_LEN + LICENSE_CONFIG.CHECKSUM_LEN)) return false;
                const prefix = cleanCode.substring(0, LICENSE_CONFIG.PREFIX_LEN);
                const inputChecksum = cleanCode.substring(LICENSE_CONFIG.PREFIX_LEN);
                const expectedChecksum = this.calculateChecksum(prefix);
                return inputChecksum === expectedChecksum;
            },

            // 生成设备绑定签名
            generateBindingSignature: function(code, fingerprint) {
                // 签名 = Hash(CleanCode + Fingerprint + Salt)
                const cleanCode = code.replace(/[-\s]/g, '').toUpperCase();
                return simpleHash(cleanCode + fingerprint + LICENSE_CONFIG.DEVICE_SALT);
            }
        };

        // =======================================================
        // 业务逻辑
        // =======================================================

        // 全局变量
        let currentDeviceFingerprint = null;
        let chart = null;
        let allData = [];
        let currentPage = 1;
        const pageSize = 10;
        let filteredData = [];
        let referenceLines = {
            goldenBuy: null,
            regularInvest: null,
            bubble: null
        };
        let indexMinMax = {
            min: null,
            max: null
        };
        let currentFileName = "未加载数据";
        let dataInterval = "unknown";
        let growthRates = [];
        let popperIndexes = [];
        let exponentialParams = {a: null, b: null};
        
        // DOM 元素
        const useSampleMonthlyDataBtn = document.getElementById('useSampleMonthlyData');
        const useSampleYearlyDataBtn = document.getElementById('useSampleYearlyData');
        const uploadDataInput = document.getElementById('uploadData');
        const updateChartBtn = document.getElementById('updateChart');
        const exportDataBtn = document.getElementById('exportData');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const dataTableBody = document.getElementById('dataTableBody');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageInfo = document.getElementById('pageInfo');
        const showingCount = document.getElementById('showingCount');
        const chartLoader = document.getElementById('chartLoader');
        const themeToggle = document.getElementById('themeToggle');
        
        const currentFileNameEl = document.getElementById('currentFileName');
        const dataPointCountEl = document.getElementById('dataPointCount');
        const dateRangeEl = document.getElementById('dateRange');
        const latestIndexValueEl = document.getElementById('latestIndexValue');
        const arh999StatusEl = document.getElementById('arh999Status');
        const popperStatusEl = document.getElementById('popperStatus');
        const detectedIntervalEl = document.getElementById('detectedInterval');
        
        const popperIndexXEl = document.getElementById('popperIndexX');
        const averageGrowthRateEl = document.getElementById('averageGrowthRate');
        const growthRateUnitEl = document.getElementById('growthRateUnit');
        
        const goldenBuyPercentInput = document.getElementById('goldenBuyPercent');
        const regularInvestPercentInput = document.getElementById('regularInvestPercent');
        const bubblePercentInput = document.getElementById('bubblePercent');
        
        const goldenBuyValueEl = document.getElementById('goldenBuyValue');
        const regularInvestValueEl = document.getElementById('regularInvestValue');
        const bubbleValueEl = document.getElementById('bubbleValue');
        const goldenBuyPercentDisplay = document.getElementById('goldenBuyPercentDisplay');
        const regularInvestPercentDisplay = document.getElementById('regularInvestPercentDisplay');
        const bubblePercentDisplay = document.getElementById('bubblePercentDisplay');
        
        const showPrice = document.getElementById('showPrice');
        const showIndex = document.getElementById('showIndex');
        
        // 示例数据
        const sampleMonthlyData = {
            dates: ['2020-01', '2020-02', '2020-03', '2020-04', '2020-05', '2020-06', '2020-07', '2020-08', '2020-09', '2020-10', '2020-11', '2020-12', '2021-01', '2021-02', '2021-03', '2021-04', '2021-05', '2021-06', '2021-07', '2021-08', '2021-09', '2021-10', '2021-11', '2021-12'],
            prices: [100, 108, 115, 125, 140, 160, 185, 210, 245, 280, 325, 370, 430, 490, 560, 640, 730, 830, 940, 1060, 1190, 1330, 1480, 1650]
        };
        const sampleYearlyData = {
            dates: ['2015-01', '2016-01', '2017-01', '2018-01', '2019-01', '2020-01', '2021-01', '2022-01', '2023-01', '2024-01'],
            prices: [100, 130, 180, 250, 350, 500, 720, 1050, 1550, 2300]
        };
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. 初始化指纹
            document.getElementById('fingerprintStatus').textContent = "正在获取硬件特征...";
            currentDeviceFingerprint = await FingerprintManager.getDeviceFingerprint();
            
            // 2. 显示部分指纹
            document.getElementById('fingerprintStatus').textContent = `设备ID: ${currentDeviceFingerprint.substring(0, 8)}... (已就绪)`;
            document.getElementById('activateBtn').disabled = false;
            document.getElementById('activateBtn').textContent = "立即激活解锁";

            // 3. 检查激活状态
            checkActivationStatus();
            
            // 绑定事件
            document.getElementById('activateBtn').addEventListener('click', handleActivation);
            document.getElementById('activationCodeInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleActivation();
            });
            
            // 管理员后台逻辑
            document.getElementById('generateBtn').addEventListener('click', generateCodes);
            document.getElementById('closeAdminBtn').addEventListener('click', () => {
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('userActivationPanel').classList.remove('hidden');
            });
            document.getElementById('copyCodesBtn').addEventListener('click', copyGeneratedCodes);
            document.getElementById('currentSecretDisplay').textContent = LICENSE_CONFIG.SECRET_KEY;

            // 原有初始化
            if (sampleMonthlyData.dates.length > 0) {
                startDateInput.value = sampleMonthlyData.dates[0];
                endDateInput.value = sampleMonthlyData.dates[sampleMonthlyData.dates.length - 1];
            }
            updatePercentDisplays();
            
            useSampleMonthlyDataBtn.addEventListener('click', () => loadSampleData('monthly'));
            useSampleYearlyDataBtn.addEventListener('click', () => loadSampleData('yearly'));
            uploadDataInput.addEventListener('change', handleFileUpload);
            updateChartBtn.addEventListener('click', updateChart);
            exportDataBtn.addEventListener('click', exportData);
            prevPageBtn.addEventListener('click', goToPrevPage);
            nextPageBtn.addEventListener('click', goToNextPage);
            themeToggle.addEventListener('click', toggleTheme);
            
            goldenBuyPercentInput.addEventListener('input', function() { this.value = Math.min(Math.max(parseInt(this.value) || 8, 1), 20); updatePercentDisplays(); highlightUpdateButton(); });
            regularInvestPercentInput.addEventListener('input', function() { this.value = Math.min(Math.max(parseInt(this.value) || 20, 5), 40); updatePercentDisplays(); highlightUpdateButton(); });
            bubblePercentInput.addEventListener('input', function() { this.value = Math.min(Math.max(parseInt(this.value) || 94, 1), 99); updatePercentDisplays(); highlightUpdateButton(); });
            
            [showPrice, showIndex].forEach(checkbox => { checkbox.addEventListener('change', () => highlightUpdateButton()); });
            startDateInput.addEventListener('change', () => highlightUpdateButton());
            endDateInput.addEventListener('change', () => highlightUpdateButton());
            
            updateDataInfo();
        });

        // =========== 核心验证逻辑 ===========
        function checkActivationStatus() {
            try {
                const storedData = localStorage.getItem(LICENSE_CONFIG.STORAGE_KEY);
                if (!storedData) return;

                const { code, signature } = JSON.parse(storedData);
                
                // 核心：重新计算当前设备环境下的签名
                const currentSignature = LicenseManager.generateBindingSignature(code, currentDeviceFingerprint);

                // 只有签名匹配才放行
                if (signature === currentSignature) {
                    unlockApp();
                } else {
                    console.warn("设备指纹不匹配，可能是LocalStorage被复制到了新设备");
                }
            } catch (e) {
                console.error("激活校验出错", e);
            }
        }

        function unlockApp() {
            const overlay = document.getElementById('activationOverlay');
            overlay.style.display = 'none';
            document.body.classList.remove('overflow-hidden');
        }

        function handleActivation() {
            const input = document.getElementById('activationCodeInput');
            const errorMsg = document.getElementById('activationError');
            const activateBtn = document.getElementById('activateBtn');
            const code = input.value.trim().toUpperCase();
            
            // 管理员后门
            if (code === 'ADMIN:GENERATE') {
                document.getElementById('userActivationPanel').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                errorMsg.classList.add('hidden');
                input.value = '';
                return;
            }

            // 1. 验证码格式校验
            if (LicenseManager.isValidFormat(code)) {
                // 2. 绑定当前设备
                const signature = LicenseManager.generateBindingSignature(code, currentDeviceFingerprint);
                
                // 3. 存储加密后的绑定信息
                const storagePayload = JSON.stringify({
                    code: code,      // 存储原始码以便重算
                    signature: signature, // 存储签名
                    activatedAt: new Date().toISOString()
                });
                
                localStorage.setItem(LICENSE_CONFIG.STORAGE_KEY, storagePayload);
                
                // 动画反馈
                activateBtn.innerHTML = '<i class="fa fa-check mr-2"></i> 验证通过，正在绑定设备...';
                activateBtn.classList.remove('from-blue-600', 'to-blue-700');
                activateBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                errorMsg.classList.add('hidden');
                input.classList.remove('border-red-500');
                
                setTimeout(() => {
                    const overlay = document.getElementById('activationOverlay');
                    overlay.classList.add('opacity-0', 'scale-110');
                    setTimeout(() => {
                        unlockApp();
                        showNotification('success', '激活成功！已绑定当前设备');
                    }, 500);
                }, 800);
                
            } else {
                errorMsg.textContent = "激活码无效，请检查输入";
                errorMsg.classList.remove('hidden');
                input.classList.add('border-red-500', 'shake');
                setTimeout(() => input.classList.remove('shake'), 500);
            }
        }
        
        function generateCodes() {
            const count = parseInt(document.getElementById('genCount').value) || 1;
            const area = document.getElementById('generatedCodesArea');
            let codes = [];
            for (let i = 0; i < count; i++) codes.push(LicenseManager.generateCode());
            area.value = codes.join('\n');
        }

        function copyGeneratedCodes() {
            const area = document.getElementById('generatedCodesArea');
            area.select();
            document.execCommand('copy');
            const btn = document.getElementById('copyCodesBtn');
            const originalText = btn.textContent;
            btn.textContent = '已复制!';
            btn.classList.add('bg-green-600');
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('bg-green-600');
            }, 1500);
        }
        // ===================================
        
        function highlightUpdateButton() {
            updateChartBtn.classList.add('pulse-effect');
            setTimeout(() => {
                updateChartBtn.classList.remove('pulse-effect');
            }, 2000);
        }
        
        function updatePercentDisplays() {
            const goldenValue = parseInt(goldenBuyPercentInput.value) || 8;
            const regularValue = parseInt(regularInvestPercentInput.value) || 20;
            const bubbleValue = parseInt(bubblePercentInput.value) || 94;
            
            goldenBuyPercentDisplay.textContent = `${goldenValue}%`;
            regularInvestPercentDisplay.textContent = `${regularValue}%`;
            bubblePercentDisplay.textContent = `${bubbleValue}%`;
        }
        
        function getPopperStatus(popperValue) {
            if (popperValue === null) return { status: "数据不足", class: "bg-gray-100 text-gray-800" };
            let threshold, status, statusClass;
            
            if (dataInterval === "monthly") {
                threshold = 10;
                if (popperValue < threshold) {
                    status = "抄底";
                    statusClass = "bg-green-100 text-green-800";
                } else {
                    status = "正常";
                    statusClass = "bg-gray-100 text-gray-800";
                }
            } else if (dataInterval === "yearly") {
                threshold = 1;
                if (popperValue < threshold) {
                    status = "抄底";
                    statusClass = "bg-green-100 text-green-800";
                } else {
                    status = "正常";
                    statusClass = "bg-gray-100 text-gray-800";
                }
            } else {
                status = "无法判断";
                statusClass = "bg-yellow-100 text-yellow-800";
            }
            return { status: status, class: statusClass, threshold: threshold };
        }
        
        function updateDataInfo() {
            currentFileNameEl.textContent = currentFileName;
            dataPointCountEl.textContent = allData.length;
            
            if (dataInterval === "monthly") {
                detectedIntervalEl.textContent = "月度数据";
                growthRateUnitEl.textContent = "每月";
            } else if (dataInterval === "yearly") {
                detectedIntervalEl.textContent = "年度数据";
                growthRateUnitEl.textContent = "每年";
            } else {
                detectedIntervalEl.textContent = "未识别";
                growthRateUnitEl.textContent = "--";
            }
            
            // 已隐藏具体的拟合系数显示，防止泄密
            
            updateGrowthAndPopperInfo();
            
            if (allData.length > 0) {
                const firstDate = allData[0].date;
                const lastDate = allData[allData.length - 1].date;
                dateRangeEl.textContent = `${firstDate} 至 ${lastDate}`;
                
                const latestIndex = allData[allData.length - 1].arh999Index;
                latestIndexValueEl.textContent = latestIndex ? latestIndex.toFixed(4) : '--';
                updateCurrentStatus();
            } else {
                dateRangeEl.textContent = "-- 至 --";
                latestIndexValueEl.textContent = "--";
                arh999StatusEl.innerHTML = `<span class="inline-block px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-800">索罗斯指数状态：等待数据加载</span>`;
                popperStatusEl.innerHTML = `<span class="inline-block px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-800">波普尔状态：等待数据加载</span>`;
            }
        }
        
        function updateGrowthAndPopperInfo() {
            if (growthRates.length === 0 || popperIndexes.length === 0) {
                popperIndexXEl.textContent = "--";
                averageGrowthRateEl.textContent = "--";
                return;
            }
            let latestPopper = null;
            for (let i = popperIndexes.length - 1; i >= 0; i--) {
                if (popperIndexes[i] !== null) {
                    latestPopper = popperIndexes[i];
                    break;
                }
            }
            
            const validRates = growthRates.filter(rate => rate !== null);
            const avgRate = validRates.length > 0 ? validRates.reduce((sum, rate) => sum + rate, 0) / validRates.length : null;
            
            popperIndexXEl.textContent = latestPopper !== null ? latestPopper.toFixed(4) : "--";
            // 恢复平均增长率显示
            averageGrowthRateEl.textContent = avgRate !== null ? `${(avgRate * 100).toFixed(2)}%` : "--";
            
            if (latestPopper !== null) {
                const popperStatus = getPopperStatus(latestPopper);
                popperStatusEl.innerHTML = `<span class="inline-block px-3 py-1 text-sm rounded-full ${popperStatus.class}">波普尔状态：${popperStatus.status} (阈值: ${popperStatus.threshold || '-'})</span>`;
            }
        }
        
        function updateCurrentStatus() {
            if (allData.length === 0 || !referenceLines.goldenBuy || !referenceLines.regularInvest || !referenceLines.bubble) return;
            
            const latestIndex = allData[allData.length - 1].arh999Index;
            if (latestIndex === null) {
                arh999StatusEl.innerHTML = `<span class="inline-block px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-800">索罗斯指数状态：数据不足，无法计算</span>`;
                return;
            }
            
            let statusClass = '', statusText = '正常区';
            
            if (latestIndex < referenceLines.goldenBuy) {
                statusClass = 'bg-green-100 text-green-800';
                statusText = '黄金买入区';
            } else if (latestIndex < referenceLines.regularInvest) {
                statusClass = 'bg-blue-100 text-blue-800';
                statusText = '定投区';
            } else if (latestIndex > referenceLines.bubble) {
                statusClass = 'bg-red-100 text-red-800';
                statusText = '泡沫区';
            } else {
                statusClass = 'bg-gray-100 text-gray-800';
                statusText = '正常区';
            }
            
            arh999StatusEl.innerHTML = `<span class="inline-block px-3 py-1 text-sm rounded-full ${statusClass}">索罗斯指数状态：${statusText}</span>`;
        }
        
        function loadSampleData(type) {
            showLoader();
            let sampleData, fileName;
            if (type === 'monthly') {
                sampleData = sampleMonthlyData;
                fileName = "示例月度数据";
                dataInterval = "monthly";
            } else {
                sampleData = sampleYearlyData;
                fileName = "示例年度数据";
                dataInterval = "yearly";
            }
            currentFileName = fileName;
            
            setTimeout(() => {
                try {
                    const processedData = processData(sampleData.dates, sampleData.prices);
                    allData = processedData;
                    filterDataByDateRange();
                    calculateIndexMinMax();
                    calculateReferenceLines();
                    renderChart();
                    renderTable();
                    updateReferenceLineDisplays();
                    updateDataInfo();
                    showNotification('success', `${fileName}加载成功，已应用智能算法`);
                } catch (error) {
                    showNotification('error', `数据加载失败: ${error.message}`);
                } finally {
                    hideLoader();
                }
            }, 800);
        }
        
        function detectDataInterval(dates) {
            if (dates.length < 2) return "unknown";
            const momentDates = dates.map(date => moment(date, 'YYYY-MM'));
            const intervals = [];
            for (let i = 1; i < momentDates.length; i++) {
                intervals.push(momentDates[i].diff(momentDates[i-1], 'months'));
            }
            const avgInterval = intervals.reduce((sum, val) => sum + val, 0) / intervals.length;
            if (avgInterval >= 10 && avgInterval <= 14) return "yearly";
            else if (avgInterval >= 0.5 && avgInterval <= 1.5) return "monthly";
            else return "unknown";
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            showLoader();
            currentFileName = file.name;
            const fileName = file.name.toLowerCase();
            const isCSV = fileName.endsWith('.csv') || fileName.endsWith('.txt');
            const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
            
            if (!isCSV && !isExcel) {
                showNotification('error', '不支持的文件格式，请上传CSV或Excel文件');
                hideLoader();
                uploadDataInput.value = '';
                return;
            }
            
            if (isCSV) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) { processParsedData(results.data); },
                    error: function(error) {
                        showNotification('error', `文件解析错误: ${error.message}`);
                        hideLoader();
                        uploadDataInput.value = '';
                    }
                });
            } else if (isExcel) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        processParsedData(jsonData);
                    } catch (error) {
                        showNotification('error', `Excel解析错误: ${error.message}`);
                        hideLoader();
                        uploadDataInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }
        
        function processParsedData(jsonData) {
            try {
                if (!jsonData || jsonData.length === 0) throw new Error('文件中没有数据');
                const firstRow = jsonData[0];
                let dateColumn = null, priceColumn = null;
                const possibleDateColumns = ['日期', '时间', 'date', 'time', '月份', '年份'];
                const possiblePriceColumns = ['价格', 'price', '价值', 'value'];
                
                for (const col of possibleDateColumns) { if (firstRow.hasOwnProperty(col)) { dateColumn = col; break; } }
                for (const col of possiblePriceColumns) { if (firstRow.hasOwnProperty(col)) { priceColumn = col; break; } }
                
                if (!dateColumn || !priceColumn) throw new Error('文件必须包含日期列和价格列（尝试识别列名：日期、时间、价格等）');
                
                const yearMonthData = [];
                const priceData = [];
                
                jsonData.forEach(row => {
                    if (row[dateColumn] && row[priceColumn]) {
                        let dateStr = row[dateColumn].toString();
                        if (!isNaN(dateStr) && dateStr.length > 5) {
                            const date = XLSX.SSF.parse_date_code(parseFloat(dateStr));
                            dateStr = `${date.y}-${(date.m + 1).toString().padStart(2, '0')}`;
                        } else {
                            const parsedDate = moment(dateStr);
                            if (parsedDate.isValid()) dateStr = parsedDate.format('YYYY-MM');
                        }
                        yearMonthData.push(dateStr);
                        priceData.push(parseFloat(row[priceColumn]));
                    }
                });
                
                if (yearMonthData.length < 2) throw new Error('至少需要2个有效数据点');
                
                dataInterval = detectDataInterval(yearMonthData);
                const processedData = processData(yearMonthData, priceData);
                allData = processedData;
                startDateInput.value = yearMonthData[0];
                endDateInput.value = yearMonthData[yearMonthData.length - 1];
                
                filterDataByDateRange();
                calculateIndexMinMax();
                calculateReferenceLines();
                renderChart();
                renderTable();
                updateReferenceLineDisplays();
                updateDataInfo();
                showNotification('success', '数据上传成功，已应用智能算法');
            } catch (error) {
                showNotification('error', `文件处理失败: ${error.message}`);
            } finally {
                hideLoader();
                uploadDataInput.value = '';
            }
        }
        
        function calculateIndexMinMax() {
            const validIndexes = allData.map(item => item.arh999Index).filter(index => index !== null && !isNaN(index));
            if (validIndexes.length < 2) { indexMinMax = { min: null, max: null }; return; }
            indexMinMax = { min: Math.min(...validIndexes), max: Math.max(...validIndexes) };
        }
        
        function processData(yearMonthData, priceData) {
            if (yearMonthData.length !== priceData.length) throw new Error('日期和价格数据长度不匹配');
            if (yearMonthData.length < 2) throw new Error('数据点不足，至少需要2个数据点');
            
            const dates = yearMonthData.map(date => moment(date, 'YYYY-MM'));
            const X = Array.from({length: yearMonthData.length}, (_, i) => i);
            const {a, b} = fitExponentialModel(X, priceData);
            exponentialParams = {a, b};
            
            const estimatePrices = X.map(x => a * Math.exp(b * x));
            growthRates = calculateGrowthRates(estimatePrices);
            const movingAverages = calculateAveragePrice(dates, priceData);
            
            const arh999Indexes = priceData.map((price, i) => {
                const avgPrice = movingAverages[i];
                const estPrice = estimatePrices[i];
                if (avgPrice <= 0 || estPrice <= 0 || !avgPrice) return null;
                return (price / avgPrice) * (price / estPrice);
            });
            
            popperIndexes = calculatePopperIndexX(arh999Indexes, growthRates);
            
            const dataWithStatus = yearMonthData.map((date, i) => {
                const popperStatus = getPopperStatus(popperIndexes[i]);
                let arh999StatusClass = 'bg-gray-100 text-gray-800';
                let arh999StatusText = '正常区';
                
                if (arh999Indexes[i] !== null && indexMinMax.min !== null && indexMinMax.max !== null) {
                    const goldenBuy = indexMinMax.min + (indexMinMax.max - indexMinMax.min) * (parseInt(goldenBuyPercentInput.value) / 100);
                    const regularInvest = indexMinMax.min + (indexMinMax.max - indexMinMax.min) * (parseInt(regularInvestPercentInput.value) / 100);
                    const bubble = indexMinMax.min + (indexMinMax.max - indexMinMax.min) * (parseInt(bubblePercentInput.value) / 100);
                    
                    if (arh999Indexes[i] < goldenBuy) { arh999StatusClass = 'bg-green-100 text-green-800'; arh999StatusText = '黄金买入区'; }
                    else if (arh999Indexes[i] < regularInvest) { arh999StatusClass = 'bg-blue-100 text-blue-800'; arh999StatusText = '定投区'; }
                    else if (arh999Indexes[i] > bubble) { arh999StatusClass = 'bg-red-100 text-red-800'; arh999StatusText = '泡沫区'; }
                }
                
                return {
                    date: date,
                    price: priceData[i],
                    estimatePrice: estimatePrices[i],
                    movingAverage: movingAverages[i],
                    arh999Index: arh999Indexes[i],
                    growthRate: growthRates[i],
                    popperIndexX: popperIndexes[i],
                    momentDate: dates[i],
                    arh999Status: { text: arh999StatusText, class: arh999StatusClass },
                    popperStatus: { text: popperStatus.status, class: popperStatus.class }
                };
            });
            return dataWithStatus;
        }
        
        function fitExponentialModel(X, Y) {
            try {
                const validIndices = Y.map((val, idx) => val > 0 ? idx : -1).filter(idx => idx !== -1);
                if (validIndices.length < 2) throw new Error('数据点不足或包含非正值，无法进行指数拟合');
                
                const xFiltered = validIndices.map(idx => X[idx]);
                const yFiltered = validIndices.map(idx => Y[idx]);
                const lnY = yFiltered.map(y => Math.log(y));
                const n = xFiltered.length;
                const sumX = xFiltered.reduce((sum, x) => sum + x, 0);
                const sumLnY = lnY.reduce((sum, y) => sum + y, 0);
                const sumX2 = xFiltered.reduce((sum, x) => sum + x * x, 0);
                const sumXLnY = xFiltered.reduce((sum, x, i) => sum + x * lnY[i], 0);
                const denominator = n * sumX2 - sumX * sumX;
                
                if (denominator === 0) throw new Error('无法进行线性回归，数据可能存在共线性问题');
                const b = (n * sumXLnY - sumX * sumLnY) / denominator;
                const lnA = (sumLnY * sumX2 - sumX * sumXLnY) / denominator;
                return {a: Math.exp(lnA), b};
            } catch (error) {
                console.error('指数拟合失败:', error);
                return {a: Y[0], b: 0.05};
            }
        }
        
        function calculateGrowthRates(estimatePrices) {
            const growthRates = [null];
            for (let i = 1; i < estimatePrices.length; i++) {
                const prevEstimate = estimatePrices[i - 1];
                const currentEstimate = estimatePrices[i];
                if (prevEstimate <= 0 || currentEstimate <= 0) growthRates.push(null);
                else growthRates.push((currentEstimate / prevEstimate) - 1);
            }
            return growthRates;
        }
        
        function calculatePopperIndexX(arh999Indexes, growthRates) {
            const popperIndexes = [];
            for (let i = 0; i < arh999Indexes.length; i++) {
                const indexValue = arh999Indexes[i];
                const growthRate = growthRates[i];
                if (indexValue === null || growthRate === null || growthRate <= 0) popperIndexes.push(null);
                else popperIndexes.push(indexValue / growthRate);
            }
            return popperIndexes;
        }
        
        function calculateAveragePrice(dates, prices) {
            const averages = [];
            if (dataInterval === "yearly") {
                for (let i = 0; i < dates.length; i++) {
                    const previousPrices = [];
                    for (let j = i - 1; j >= 0 && previousPrices.length < 2; j--) previousPrices.push(prices[j]);
                    if (previousPrices.length > 0) averages.push(previousPrices.reduce((a, b) => a + b, 0) / previousPrices.length);
                    else averages.push(null);
                }
            } else {
                for (let i = 0; i < dates.length; i++) {
                    const currentDate = dates[i];
                    const twelveMonthsBefore = moment(currentDate).subtract(12, 'months');
                    const relevantPrices = [];
                    for (let j = 0; j < i; j++) {
                        if (dates[j].isAfter(twelveMonthsBefore) && dates[j].isBefore(currentDate)) relevantPrices.push(prices[j]);
                    }
                    if (relevantPrices.length === 0) for (let j = 0; j < i; j++) relevantPrices.push(prices[j]);
                    if (relevantPrices.length > 0) averages.push(relevantPrices.reduce((a, b) => a + b, 0) / relevantPrices.length);
                    else averages.push(null);
                }
            }
            return averages;
        }
        
        function calculateReferenceLines() {
            if (indexMinMax.min === null || indexMinMax.max === null) {
                referenceLines = { goldenBuy: null, regularInvest: null, bubble: null };
                return;
            }
            const goldenBuyPercent = Math.min(Math.max(parseInt(goldenBuyPercentInput.value) || 8, 1), 20) / 100;
            const regularInvestPercent = Math.min(Math.max(parseInt(regularInvestPercentInput.value) || 20, 5), 40) / 100;
            const bubblePercent = Math.min(Math.max(parseInt(bubblePercentInput.value) || 94, 1), 99) / 100;
            const indexRange = indexMinMax.max - indexMinMax.min;
            referenceLines = {
                goldenBuy: indexMinMax.min + indexRange * goldenBuyPercent,
                regularInvest: indexMinMax.min + indexRange * regularInvestPercent,
                bubble: indexMinMax.min + indexRange * bubblePercent
            };
            updateReferenceLineDisplays();
        }
        
        function updateReferenceLineDisplays() {
            goldenBuyValueEl.textContent = referenceLines.goldenBuy ? referenceLines.goldenBuy.toFixed(4) : '--';
            regularInvestValueEl.textContent = referenceLines.regularInvest ? referenceLines.regularInvest.toFixed(4) : '--';
            bubbleValueEl.textContent = referenceLines.bubble ? referenceLines.bubble.toFixed(4) : '--';
        }
        
        function filterDataByDateRange() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            if (!startDate || !endDate || allData.length === 0) { filteredData = [...allData]; return; }
            filteredData = allData.filter(item => item.date >= startDate && item.date <= endDate);
        }
        
        function renderChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chart) chart.destroy();
            const labels = filteredData.map(item => item.date);
            const prices = filteredData.map(item => item.price);
            const indexes = filteredData.map(item => item.arh999Index);
            
            const datasets = [];
            if (showPrice.checked) datasets.push({ label: '历史价格', data: prices, borderColor: '#000000', backgroundColor: 'rgba(0, 0, 0, 0.05)', borderWidth: 2, fill: false, yAxisID: 'y' });
            // 已隐藏指数拟合线和均线，只保留价格和指数
            
            if (showIndex.checked) datasets.push({ label: '索罗斯指数', data: indexes, borderColor: '#F53F3F', backgroundColor: 'rgba(245, 63, 63, 0.1)', borderWidth: 2, fill: true, yAxisID: 'y1' });
            
            const annotationPlugin = {
                id: 'annotation',
                beforeDraw: (chart) => {
                    if (!showIndex.checked) return;
                    const {ctx, scales} = chart;
                    const y1Scale = scales.y1;
                    
                    if (referenceLines.goldenBuy !== null) {
                        const lineYGolden = y1Scale.getPixelForValue(referenceLines.goldenBuy);
                        ctx.save(); ctx.beginPath(); ctx.moveTo(scales.x.getPixelForValue(0), lineYGolden); ctx.lineTo(scales.x.getPixelForValue(labels.length - 1), lineYGolden);
                        ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(72, 187, 120, 0.8)'; ctx.setLineDash([5, 5]); ctx.stroke();
                        ctx.fillStyle = 'rgba(72, 187, 120, 0.9)'; ctx.font = '12px sans-serif'; ctx.fillText(`黄金买入线 (${goldenBuyPercentDisplay.textContent})`, scales.x.getPixelForValue(0) + 5, lineYGolden - 5); ctx.restore();
                    }
                    if (referenceLines.regularInvest !== null) {
                        ctx.save(); const lineYRegular = y1Scale.getPixelForValue(referenceLines.regularInvest);
                        ctx.beginPath(); ctx.moveTo(scales.x.getPixelForValue(0), lineYRegular); ctx.lineTo(scales.x.getPixelForValue(labels.length - 1), lineYRegular);
                        ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(59, 130, 246, 0.8)'; ctx.setLineDash([5, 5]); ctx.stroke();
                        ctx.fillStyle = 'rgba(59, 130, 246, 0.9)'; ctx.font = '12px sans-serif'; ctx.fillText(`定投线 (${regularInvestPercentDisplay.textContent})`, scales.x.getPixelForValue(0) + 5, lineYRegular - 5); ctx.restore();
                    }
                    if (referenceLines.bubble !== null) {
                        ctx.save(); const lineYBubble = y1Scale.getPixelForValue(referenceLines.bubble);
                        ctx.beginPath(); ctx.moveTo(scales.x.getPixelForValue(0), lineYBubble); ctx.lineTo(scales.x.getPixelForValue(labels.length - 1), lineYBubble);
                        ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(239, 68, 68, 0.8)'; ctx.setLineDash([5, 5]); ctx.stroke();
                        ctx.fillStyle = 'rgba(239, 68, 68, 0.9)'; ctx.font = '12px sans-serif'; ctx.fillText(`泡沫线 (${bubblePercentDisplay.textContent})`, scales.x.getPixelForValue(0) + 5, lineYBubble - 5); ctx.restore();
                    }
                }
            };
            
            // 已移除方程显示插件
            
            chart = new Chart(ctx, {
                type: 'line',
                plugins: [annotationPlugin],
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { title: { display: true, text: '日期' }, ticks: { maxRotation: 45, minRotation: 45, maxTicksLimit: 12 } },
                        y: { type: 'linear', display: showPrice.checked, position: 'left', title: { display: true, text: '价格' }, grid: { drawOnChartArea: false } },
                        y1: { type: 'linear', display: showIndex.checked, position: 'right', title: { display: true, text: '索罗斯指数' }, grid: { drawOnChartArea: false } }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { callbacks: { label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.y !== null) {
                                if (context.dataset.yAxisID === 'y') label += context.parsed.y.toFixed(2);
                                else if (context.dataset.yAxisID === 'y1') label += context.parsed.y.toFixed(4);
                            }
                            return label;
                        }}}
                    }
                }
            });
        }
        
        function renderTable() {
            currentPage = 1;
            const totalPages = Math.ceil(filteredData.length / pageSize);
            updatePagination(totalPages);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredData.length);
            const currentData = filteredData.slice(startIndex, endIndex);
            
            dataTableBody.innerHTML = '';
            if (currentData.length === 0) {
                dataTableBody.innerHTML = '<tr class="px-4 py-8 text-center text-neutral"><td colspan="9">没有数据</td></tr>';
                return;
            }
            
            // 表格中已移除估值和增长率等敏感列
            currentData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-custom';
                let popperHtml = item.popperIndexX !== null ? item.popperIndexX.toFixed(4) : '-';
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">${item.date}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${item.price.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${item.arh999Index ? item.arh999Index.toFixed(4) : '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${popperHtml}</td>
                    <td class="px-4 py-3 whitespace-nowrap"><span class="px-2 py-1 text-xs rounded-full ${item.arh999Status.class}">${item.arh999Status.text}</span></td>
                    <td class="px-4 py-3 whitespace-nowrap"><span class="px-2 py-1 text-xs rounded-full ${item.popperStatus.class}">${item.popperStatus.text}</span></td>
                `;
                dataTableBody.appendChild(row);
            });
            showingCount.textContent = filteredData.length;
        }
        
        function updatePagination(totalPages) {
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
        }
        
        function goToPrevPage() { if (currentPage > 1) { currentPage--; renderTable(); } }
        function goToNextPage() { const totalPages = Math.ceil(filteredData.length / pageSize); if (currentPage < totalPages) { currentPage++; renderTable(); } }
        
        function exportData() {
            if (allData.length === 0) { showNotification('warning', '没有数据可导出'); return; }
            const growthRateUnit = dataInterval === "yearly" ? "每年" : "每月";
            // 导出数据中已移除敏感计算列
            let csvContent = `日期,价格,索罗斯指数,波普尔指标X,索罗斯指数状态,波普尔状态\n`;
            allData.forEach(item => {
                csvContent += `${item.date},${item.price.toFixed(2)},${item.arh999Index ? item.arh999Index.toFixed(4) : ''},${item.popperIndexX !== null ? item.popperIndexX.toFixed(4) : ''},${item.arh999Status.text},${item.popperStatus.text}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `soros_index_v13_data_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('success', '数据导出成功');
        }
        
        function updateChart() {
            if (allData.length === 0) { showNotification('warning', '请先加载数据'); return; }
            showLoader();
            setTimeout(() => {
                try {
                    const reprocessedData = processData(allData.map(item => item.date), allData.map(item => item.price));
                    allData = reprocessedData;
                    filterDataByDateRange();
                    calculateIndexMinMax();
                    calculateReferenceLines();
                    renderChart();
                    renderTable();
                    updateReferenceLineDisplays();
                    updateDataInfo();
                    showNotification('success', '图表已更新，智能算法已应用');
                } catch (error) {
                    showNotification('error', `更新失败: ${error.message}`);
                } finally {
                    hideLoader();
                }
            }, 500);
        }
        
        function showLoader() { chartLoader.classList.remove('hidden'); }
        function hideLoader() { chartLoader.classList.add('hidden'); }
        
        function showNotification(type, message) {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const text = document.getElementById('notificationText');
            notification.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center z-50';
            if (type === 'success') { notification.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-200'); icon.className = 'fa fa-check-circle mr-2'; }
            else if (type === 'error') { notification.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200'); icon.className = 'fa fa-exclamation-circle mr-2'; }
            else if (type === 'warning') { notification.classList.add('bg-yellow-50', 'text-yellow-700', 'border', 'border-yellow-200'); icon.className = 'fa fa-exclamation-triangle mr-2'; }
            text.textContent = message;
            setTimeout(() => { notification.classList.add('translate-y-20', 'opacity-0'); }, 3000);
        }
        
        function toggleTheme() {
            const icon = themeToggle.querySelector('i');
            document.body.classList.toggle('dark-mode');
            if (document.body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon-o'); icon.classList.add('fa-sun-o');
                document.body.classList.add('bg-gray-900', 'text-white');
                document.body.classList.remove('bg-gray-50', 'text-dark');
            } else {
                icon.classList.remove('fa-sun-o'); icon.classList.add('fa-moon-o');
                document.body.classList.remove('bg-gray-900', 'text-white');
                document.body.classList.add('bg-gray-50', 'text-dark');
            }
            if (chart) renderChart();
        }
    </script>
</body>
    </html>
